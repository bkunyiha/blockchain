#!/bin/bash
# Incremental scaling script - removes one instance at a time
# Automatically updates port mappings so remaining instances have ports accessible externally
# Usage: ./scale-down.sh [service] [current_count]
# Example: ./scale-down.sh webserver 3  (scales webservers from 3 to 2)

set -e

SERVICE=${1:-webserver}
CURRENT_COUNT=${2:-2}
NEW_COUNT=$((CURRENT_COUNT - 1))

if [ "${NEW_COUNT}" -lt 1 ]; then
    echo "Error: Cannot scale below 1 instance"
    exit 1
fi

echo "Scaling ${SERVICE} down: ${CURRENT_COUNT} → ${NEW_COUNT}"
echo ""

# Get current counts for both services
CURRENT_MINERS=$(docker-compose ps -q miner 2>/dev/null | wc -l | tr -d ' ')
CURRENT_WEBSERVERS=$(docker-compose ps -q webserver 2>/dev/null | wc -l | tr -d ' ')

# Determine new counts after scaling
if [ "${SERVICE}" = "miner" ]; then
    NEW_MINERS=${NEW_COUNT}
    NEW_WEBSERVERS=${CURRENT_WEBSERVERS}
else
    NEW_MINERS=${CURRENT_MINERS}
    NEW_WEBSERVERS=${NEW_COUNT}
fi

# Generate port override file for updated counts
echo "Updating port mappings..."
OUTPUT_FILE="docker-compose.override.yml"

cat > "${OUTPUT_FILE}" <<EOF
version: '3.8'

# Auto-generated port mappings for multiple instances
# Generated by: scale-down.sh
# This ensures ALL instances have ports accessible externally

services:
  miner:
    ports:
EOF

# Generate miner port mappings
for i in $(seq 1 ${NEW_MINERS}); do
    P2P_PORT=$((2001 + i - 1))
    echo "      - \"${P2P_PORT}:${P2P_PORT}\"  # Miner instance ${i}" >> "${OUTPUT_FILE}"
done

cat >> "${OUTPUT_FILE}" <<EOF

  webserver:
    ports:
EOF

# Generate webserver port mappings
for i in $(seq 1 ${NEW_WEBSERVERS}); do
    WEB_PORT=$((8080 + i - 1))
    P2P_PORT=$((2101 + i - 1))
    INTERNAL_P2P=$((2001 + i - 1))
    echo "      - \"${WEB_PORT}:${WEB_PORT}\"  # Webserver instance ${i} - Web" >> "${OUTPUT_FILE}"
    echo "      - \"${P2P_PORT}:${INTERNAL_P2P}\"  # Webserver instance ${i} - P2P" >> "${OUTPUT_FILE}"
done

echo "  ✓ Updated ${OUTPUT_FILE}"
echo ""

# Scale down by one
docker-compose up -d --no-recreate --scale ${SERVICE}=${NEW_COUNT}

echo ""
echo "Waiting for container removal..."
sleep 5

echo ""
echo "Current ${SERVICE} containers:"
docker-compose ps ${SERVICE}

echo ""
echo "✓ Port mappings updated - remaining instances have ports accessible externally"

